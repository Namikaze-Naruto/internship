name: Daily Scraper & Deploy

on:
  schedule:
    # Run daily at 9:00 AM UTC (2:30 PM IST)
    - cron: '0 9 * * *'
  
  workflow_dispatch: # Allow manual trigger
  
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'docs/**'
      - '.github/workflows/**'

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Create necessary directories
        run: |
          mkdir -p data/internships
          mkdir -p logs
          mkdir -p docs/data
      
      - name: Run scraper
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          HOURS_LOOKBACK: ${{ vars.HOURS_LOOKBACK || '168' }}
          API_PER_PAGE: ${{ vars.API_PER_PAGE || '20' }}
          REQUEST_DELAY_SECONDS: ${{ vars.REQUEST_DELAY_SECONDS || '2' }}
          LOG_LEVEL: 'INFO'
        run: |
          python -m src.scraper
      
      - name: Check if data changed
        id: check_changes
        run: |
          if git diff --quiet docs/data/internships.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/data/internships.json
          git add data/internships.db
          git add data/internships/*.json
          git commit -m "ðŸ¤– Daily scrape: $(date +'%Y-%m-%d %H:%M:%S')" || exit 0
          git push
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: steps.check_changes.outputs.changed == 'true' || github.event_name == 'push'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'ðŸš€ Deploy: ${{ github.event.head_commit.message }}'
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-logs-${{ github.run_number }}
          path: |
            logs/*.log
            data/internships/*.json
          retention-days: 7
